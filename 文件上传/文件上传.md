## 文件上传检测方式
```
通常一个文件以HTTP协议进行上传时，将以POST请求发送至web服务器,web服务器接收到请求并同意后，用户与web服务器将建立连接，并传输data。
A 客户端 javascript 检测 (通常为检测文件扩展名)
B 服务端 MIME 类型检测 (检测 Content-Type 内容)
C 服务端目录路径检测 (检测跟 path 参数相关的内容)
D 服务端文件扩展名检测 (检测跟文件extension相关的内容)
E 服务端文件内容检测 (检测内容是否合法或含有恶意代码)
```
## A 客户端 javascript 检测及绕过
```
原理：这类检测通常在上传页面里含有专门检测文件上传的 javascript 代码，在文件上传之前进行检测，最常见的就是检测上传文件的文件类型和扩展名是否合法。
绕过：我们可以通过 burpsuit 之类的抓包代理工具进行绕过提交，实现文件上传。
利用：创建一个允许上传的文件类型，写入我们需要的
代码，抓包拦截，修改为可执行的文件类型
```
## B 服务端 MIME 类型检测及绕过
```
原理：这类检测方法通过检查http包的Content-Type字段中的值来判断上传文件是否合法
绕过：可以通过burpsuit代理工具直接修改Content-Type类型字段绕过
利用：创建一个.php一句话木马文件，上传文件时burpsuit抓包拦截，直接修改Content-Type：允许的MIME类型
MIME的作用: 使客户端软件，区分不同种类的数据，例如web浏览器就是通过MIME类型来判断文件是GIF图片，还是可打印的PostScript文件。
web服务器使用MIME来说明发送数据的种类， web客户端使用MIME来说明希望接收到的数据种类。
```

## 常见的MIME类型
```
1. 超文本标记语言文本 .html text/html
2. 普通文本 .txt text/plain
3. PDF文档 .pdf application/pdf
4. AVI文件 .avi video/x-msvideo
5. PNG图像 .png image/png
6. GIF图形 .gif image/gif
7. RTF文本 .rtf application/rtf
8. JPEG图形 .jpeg,.jpg image/jpeg
9. MPEG文件 .mpg,.mpeg video/mpeg
10. Microsoft Word文件 .word application/msword
```

## C 服务端目录路径检测及绕过
```
原理：这类检测一般通过检测路径是否合法来判断。
绕过：服务端判断文件类型是从后往前判断，而对文件解析是从前往后解析，我们可以利用0x00截断的方式进行绕过。
利用：
1.新建一个写入一句话木马的php文件n.php，更改文件名为n.php.jpg，在上传文件时，用burpsuit抓包，手动在.jpg前输入空格，然后在hex里更改空格的16进制数20为00。
2.找一张小于100kb的图片，命名为h.php.jpg，新建一个写入了一句话木马的php文件，然后我们需要用到windows下的dos命令 copy (形如copy 1.jpg/b+1.php 2.jpg)（参数/b指定以二进制格式复制、合并文件)制作一句话图片马，文件上传时，burp抓包，在.jpg前加空格，然后在hex里改空格的16进制20为编码0x00
```

## D 服务端文件扩展名检测
```
检测机制：通常检测跟文件扩展名相关的内容，当浏览器将文件提交到服务器端的时候，服务器端会根据设定的黑白名单对浏览器提交上来的文件扩展名进行检测，如果上传的文件扩展名符合黑白名单的限制，则上传成功，否则不允许上传
```
## 文件扩展名检测有两种策略：黑名单策略和白名单策略
```
[*]黑名单策略：文件扩展名在黑名单中为不合法
 黑名单的安全性比白名单的安全性低很多，攻击手法也比白名单多，一般有个专门的 blacklist 文件，里面会包含常见的危险脚本文件。
[*]白名单策略：文件扩展名不在白名单中为不合法
 白名单相对黑名单要安全些，但也不是说绝对的安全黑名单策略、白名单策略
```
## 黑名单检测绕过
```
1. 文件名大小写绕过。用像 AsP，pHp 之类的文件名绕过黑名单检测
2. 名单列表绕过 。用黑名单里没有的名单进行攻击，比如黑名单里没有 asa 或 cer 之类
3. 特殊文件名绕过。比如发送的 http 包里把文件名改成test.asp. 或 test.asp_(下划线为空格)，这种命名方式 在windows 系统里是不被允许的，所以需要在 burpsuite里进行修改，然后绕过验证后，会 被 windows 系统自动去掉后面的点和空格，但要注意 Unix/Linux 系统没有这个特性。
4. 0x00 截断绕过。假如这时候获取到的文件名是test.php.jpg(php 后面为 0x00) ，处理方式是从后往前扫描扩展名，所以判断为 jpg，是以 0x00 作为文件名截断，最后以 test.php 存入路径里
5. .htaccess 文件攻击 配合名单列表绕过。上传一个自定义的.htaccess，就可以轻松绕过各种检测
6. 解析调用/漏洞绕过。这类漏洞直接配合上传一个代码注入过的非黑名单文件即可，再利用解析调用/漏洞
```
## 白名单检测绕过
```
1. 0x00 截断绕过
用像 test.asp%00.jpg 的方式进行截断，属于白名单文件，再利用服务端代码的检测逻辑漏洞进行攻击，目前只遇到过 asp 的程序有这种漏洞
2. 解析调用/漏洞绕过
这类漏洞直接配合上传一个代码注入过的白名单文件即可，再利用解析调用/漏洞文件上传.htaccess 文件攻击 配合黑名单列表绕过，上传一个自定义的.htaccess，就可以轻松绕过各种检测
.htaccess文件(又称"分布式配置文件"）,全称是Hypertext Access(超文本入口)。提供了针对目录改变配置的方法， 即，在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。
.htaccess 文件攻击针对php，上传自定义.htaccess
<FilesMatch "haha">
SetHandler application/x-httpd-php
</FilesMatch>
同目录我们上传一个只有文件名并包含字符串”haha”，但是却无任何扩展名的文件,里面的内容是 php 一句话木马，通过菜刀连接可以解析php
```


## E 服务端文件内容检测: 一般通过检测文件内容来判断上传文件是否合法。
```
主要有两种检测方法：
A. 通过检测上传文件内容开始处的文件幻数来判断。 通常情况下，通过判断前10个字节，基本就能判断出一个文件的真实类型。
B. 文件加载检测。
 一般是调用API或函数对文件进行加载测试。常见的是图像渲染测试，再严格点的甚至是进行二次渲染。
```
## 文件幻数检测
```
主要是检测文件内容开始处的文件幻数 文件格式幻数（magic number），它可以用来标记文件或者协议的格式，很多文件都有幻数标志来表明该文件的格式。
比如图片类型的文件幻数如下：
1 要绕过 jpg 文件幻数检测就要在文件开头写上下面的值：
Value = FF D8 FF E0 00 10 4A 46 49 46
2 要绕过 gif 文件幻数检测就要在文件开头写上下面的值：
Value = 47 49 46 38 39 61
3 要绕过 png 文件幻数检测就要在文件开头写上下面的值：
Value = 89 50 4E 47
然后在文件幻数后面加上自己的一句话木马代码就行了。
文件加载检测
 一般是调用API 或函数去进行文件加载测试，我们常见的是图像渲染测试，严格的进行二次渲染 对渲染/加载测试的攻击方式是代码注入绕过 对二次渲染的攻击方式是攻击文件加载器自身
```
## 文件加载检测
```
1.对渲染/加载测试攻击 - 代码注入绕过 可以用图像处理软件对一张图片进行代码注入，可以用winhex 工具对图像数据进行分析，这类攻击的原理是：在不破坏文件本身的渲染情况下找一个空白区进行填充代码，一般是图片的注释区，这样能保证本身文件结构是完整的，对于渲染测试基本上都能绕过
2.二次渲染的攻击方式 - 攻击文件加载器自身 这种情况下无法用代码注入绕过，二次渲染相当于吧原本属于图像数据的部分抓出来，在用自己的API或函数进行重新渲染，而非图像数据部分直接被隔离开了。 我们可以用溢出攻击对文件加载器进行攻击，上传自己的恶意文件后，服务器上的文件加载器会主动进行加载测试，加载测试时被溢出攻击执行shellcode。
```
## 解析攻击
```
按攻击角度分类有：
1. 直接解析。比如我们直接上传一个扩展名是.php 的文件，只需要简单地绕过客户端 javascript 检测或者服务端 MIME 类型检测就行了
2. 配合解析。我们可以理解为先上传一个带有一句话木马的图片或文件让它待在服务器某个位置，等待这一个解析的配合，比如web服务器的解析漏洞，.htaccess 解析等
```
## web 应用程序解析漏洞以及原理
```
[*] Apache 解析漏洞
形式：test.php.任意不属于黑名单且也不属于Apache解析白名单的名称 
原理：Apache 解析文件的规则是从右到左开始判断解析,如果后缀名为不可识别文件解析,就再往左判断。比如test.php.qwe.asd “.qwe”和”.asd” 这两种后缀是
apache不可识别解析,apache就会把test.php.qwe.asd解析成php。
www.xxxx.xxx.com/test.php.php123
[*] Apache 解析漏洞配置问题导致漏洞
（1）如果在 Apache 的 conf 里有这样一行配置AddHandler php5-script .php 这时只要文件名里包含.php 即使文件名是 test2.php.jpg 也会以 php 来执行。
（2）如果在 Apache 的 conf 里有这样一行配置AddType application/x-httpd-php .jpg 即使扩展名是jpg，一样能以 php 方式执行。

[*] IIS 解析漏洞(IIS 5.X/6.X)目录解析
形式：www.xxx.com/xx.asp/xx.jpg
原理: 服务器默认会把.asp目录下的文件都解析成asp文件。
文件解析
形式：www.xxx.com/xx.asp;.jpg
原理：服务器默认不解析;号后面的内容，因此xx.asp;.jpg便被解析成asp文件了。
文件上传
[*] IIS 解析漏洞(IIS 7.0/7.5)
形式：任意文件名/任意文件名.php  IIS7.0/7.5 是对 php 解析时有一个类似于 Nginx 的解析漏洞，对任意文件名只要在 URL后面追加上字符串"/任意文件名.php"就会按照 php 的方式去解析
文件上传
[*] Nginx 解析漏洞
形式：任意文件名/任意文件名.php 一个在任意文件名后面添加 /任意文件名php 的解析漏洞，比如原本文件名是 test.jpg，可以添加为test.jpg/x.php 进行解析攻击。
形式：任意文件名%00.php 对低版本的 Nginx 可以在任意文件名后面添加%00.php 进行解析攻击。Nginx版本 <=0.8.37 空字节代码执行漏洞）
```
从漏洞原理来总结有 4 类 web 应用程序解析漏洞
```
[*]Apache 的扩展名顺序解析漏洞 这个是 Apache 自身的漏洞
[*] IIS 的 asp 解析漏洞 这个是 IIS 自身的漏洞
[*] Nginx 的%00 解析漏洞 这个是 Nginx 自身的漏洞
[*] php-cgi 的默认配置漏洞 这类漏洞主要出现在 IIS 和 Nginx
这类以 CGI 形式调用 php 的web 应用程序，而 Apache 通常
是以 module 的形式去调用 php，所以很少出现这个漏洞
```
文件上传攻击框架
```
1 轻量级检测绕过攻击
[*] 绕过 javascript 对扩展名的检测 <用 burp 之类的反向代理工具直接 POST 数据包到服务端，绕过前端检测>
[*] 绕过服务端对 http request 包 MIME 类型检测 <用 burp 之类的反向代理工具伪造 POST 数据包到服务端，绕过 MIME 检测>
2 路径/扩展名检测绕过攻击
[*] 黑名单绕过
文件名大小写绕过、名单列表绕过、特殊文件名绕过、0x00截断绕过、.htaccess文件攻击、本地包含漏洞、Apache解析漏洞、IIS解析漏洞、Nginx解析漏洞
[*] 白名单绕过
0x00 截断绕过 本地文件包含漏洞 IIS 解析漏洞 Nginx 解析漏洞
文件上传
3 文件内容检测绕过攻击
[*] 文件加载测试绕过 <对文件进行代码注入再配合任意解析调用/漏洞>
```